stages:
  - lint
  - build
  - test
  - verify

default:
  image: alpine:3.20
  before_script:
    - apk add --no-cache build-base meson ninja python3 bash

lint:c99:
  stage: lint
  script:
    - meson setup build-lint -Dc_args=-std=c99
    - meson compile -C build-lint

lint:commit-msg:
  stage: lint
  script:
    - chmod +x scripts/check-commit-msg.sh
    - scripts/check-commit-msg.sh "${CI_COMMIT_MESSAGE:-chore(ci): default}"

build:linux:
  stage: build
  script:
    - meson setup build
    - meson compile -C build
  artifacts:
    paths:
      - build/

# Build variant: globally define XXH_INLINE_ALL to catch include-order / inline
# mismatches between translation units (helps detect the kind of bug fixed in
# src/xxh3_converters.h where header-order caused incompatible typedefs).
build:inline:
  stage: build
  script:
    - meson setup build-inline -Dc_args=-DXXH_INLINE_ALL
    - meson compile -C build-inline
  artifacts:
    paths:
      - build-inline/

# Debug build: meson buildtype=debug does NOT define NDEBUG, so all
# #ifndef NDEBUG parameter-validation guards are active. This catches
# regressions in the guard code itself and validates guard branch coverage.
build:debug:
  stage: build
  script:
    - meson setup build-debug -Dbuildtype=debug
    - meson compile -C build-debug
  artifacts:
    paths:
      - build-debug/

build:matrix:
  stage: build
  parallel:
    matrix:
      - TARGET_OS: "linux"
        TARGET_ARCH: "x86_64"
      - TARGET_OS: "linux"
        TARGET_ARCH: "aarch64"
      - TARGET_OS: "macos"
        TARGET_ARCH: "arm64"
  script:
    - echo "Running matrix build for ${TARGET_OS}/${TARGET_ARCH}"
    - meson setup build-${TARGET_OS}-${TARGET_ARCH}
    - meson compile -C build-${TARGET_OS}-${TARGET_ARCH}

test:unit:
  stage: test
  needs: ["build:linux"]
  script:
    - meson test -C build --print-errorlogs

# Run unit tests against the build that enabled XXH_INLINE_ALL to catch
# include-order / inline mismatches early.
test:inline:
  stage: test
  needs: ["build:inline"]
  script:
    - meson test -C build-inline --print-errorlogs

# Run unit tests in debug mode to validate the #ifndef NDEBUG guard branches.
test:debug:
  stage: test
  needs: ["build:debug"]
  script:
    - meson test -C build-debug --print-errorlogs

test:abi:
  stage: test
  needs: ["build:linux"]
  script:
    - chmod +x scripts/check-abi.sh
    - scripts/check-abi.sh

test:integration:
  stage: test
  needs: ["build:linux"]
  script:
    - chmod +x tests/integration/check-cr-xxhash.sh
    - tests/integration/check-cr-xxhash.sh

verify:bench:
  stage: verify
  needs: ["build:linux"]
  script:
    - ./build/bench_variants

verify:reproducible:
  stage: verify
  script:
    - chmod +x scripts/repro-check.sh
    - scripts/repro-check.sh
