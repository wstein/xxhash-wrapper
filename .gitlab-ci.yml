stages:
  - lint
  - build
  - test
  - verify

default:
  image: alpine:3.20
  before_script:
    - apk add --no-cache build-base meson ninja python3 bash

lint:c99:
  stage: lint
  script:
    - meson setup build-lint -Dc_args=-std=c99
    - meson compile -C build-lint

lint:commit-msg:
  stage: lint
  script:
    - chmod +x scripts/check-commit-msg.sh
    - scripts/check-commit-msg.sh "${CI_COMMIT_MESSAGE:-chore(ci): default}"

build:linux:
  stage: build
  script:
    - meson setup build
    - meson compile -C build
  artifacts:
    paths:
      - build/

build:matrix:
  stage: build
  parallel:
    matrix:
      - TARGET_OS: "linux"
        TARGET_ARCH: "x86_64"
      - TARGET_OS: "linux"
        TARGET_ARCH: "aarch64"
      - TARGET_OS: "macos"
        TARGET_ARCH: "arm64"
  script:
    - echo "Running matrix build for ${TARGET_OS}/${TARGET_ARCH}"
    - meson setup build-${TARGET_OS}-${TARGET_ARCH}
    - meson compile -C build-${TARGET_OS}-${TARGET_ARCH}

test:unit:
  stage: test
  needs: ["build:linux"]
  script:
    - meson test -C build --print-errorlogs

test:abi:
  stage: test
  needs: ["build:linux"]
  script:
    - chmod +x scripts/check-abi.sh
    - scripts/check-abi.sh

test:integration:
  stage: test
  needs: ["build:linux"]
  script:
    - chmod +x tests/integration/check-cr-xxhash.sh
    - tests/integration/check-cr-xxhash.sh

verify:bench:
  stage: verify
  needs: ["build:linux"]
  script:
    - ./build/bench_variants

verify:reproducible:
  stage: verify
  script:
    - chmod +x scripts/repro-check.sh
    - scripts/repro-check.sh
